---
title: "Основы программирования в R"
subtitle: "Библиотека `dplyr`: продолжение"
author: "Алла Тамбовцева"
output: html_document
---

### Функции `summarize()`, `group_by()` и `tally()`

Загрузим датасет, с которым мы работали в прошлый раз:

```{r}
chile <- read.csv("http://math-info.hse.ru/f/2017-18/ps-ms/Chile.csv")
```

Сейчас речь пойдет, пожалуй, о самых полезных функциях `dplyr` :)

При работе с данными мы часто сталкиваемся с тем, что нам нужно получить какую-то сводную информацию по переменным. Для этого существует функция `summarise()`. Попробуем пока получить общее число строк в базе данных:

```{r, message=FALSE, warning=FALSE}
library(dplyr)
chile %>% summarise(total = n())
```

Функция `n()` универсальна, она используется для подсчета элементов. К ней мы ещё вернемся.

Теперь сделаем что-нибудь более интересное. Определим минимальное, максимальное и среднее значение возраста респондентов в этом датафрейме. 

```{r}
chile %>% summarise(avg_age = mean(age), 
                    min_age = min(age), 
                    max_age = max(age))
```

Почему R не хочет ничего считать? Потому что в переменно `age` есть пропущенные значения! Как справиться с этой проблемой? Самое простое и очевидное — удалить `NA` из базы. Но это необязательно. У многих функций в R, работающих с переменными, есть параметр `na.rm`, который позволяет зафиксировать, исключать ли пропущенные значения (*rm* от *remove*) при подсчёте или нет.

```{r}
chile %>% summarise(avg_age = mean(age, na.rm = TRUE), 
                    min_age = min(age, na.rm = TRUE), 
                    max_age = max(age,na.rm = TRUE))
```

Теперь всё в порядке.

Часто необходимо получить сводную информацию не по всем наблюдениям в базе, а по определенной группе. Для этого сначала нужно сгруппировать данные, основываясь на значениях какой-нибудь переменной. Воспользуемся функцией `group_by()` и посмотрим, сколько в базе респондентов из разных регионов: 

```{r}
chile %>% group_by(region) %>% summarise(count_reg = n())
```

А теперь посмотрим на средний возраст респондентов из разных регионов:

```{r}
chile %>% group_by(region) %>% summarise(avg_income = mean(age, na.rm = TRUE))
```

Число наблюдений можно посчитать и по-другому — с помощью функции `tally`:

```{r}
chile %>% group_by(sex) %>% summarise(count_sex = n())
chile %>% group_by(sex) %>% tally()
```
